# GitHub Actions Workflow - Architecture Documentation
# Complete, clean version that works with our beautiful index.html

name: üèóÔ∏è Architecture Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'

env:
  STRUCTURIZR_VERSION: '2025.05.28'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    name: üèóÔ∏è Build Architecture Documentation
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üì¶ Cache Structurizr CLI
      uses: actions/cache@v3
      with:
        path: ~/.structurizr
        key: structurizr-${{ env.STRUCTURIZR_VERSION }}
        
    - name: üîß Setup Structurizr CLI
      run: |
        echo "üîß Installing Structurizr CLI..."
        mkdir -p ~/.structurizr
        cd ~/.structurizr
        
        # Check if already installed
        if [ ! -f "structurizr.sh" ]; then
          echo "üì• Downloading Structurizr CLI..."
          wget -q "https://github.com/structurizr/cli/releases/download/v${{ env.STRUCTURIZR_VERSION }}/structurizr-cli.zip"
          echo "üì¶ Extracting (force overwrite)..."
          unzip -o -q structurizr-cli.zip
          chmod +x structurizr.sh
          echo "üóëÔ∏è Cleaning up..."
          rm -f structurizr-cli.zip
        else
          echo "‚úÖ Structurizr CLI already installed (from cache)"
        fi
        
        ./structurizr.sh version
        echo "‚úÖ Structurizr CLI ready"
        
    - name: üîç Validate C4 DSL
      run: |
        echo "üîç Validating C4 DSL..."
        cd docs/c4
        ~/.structurizr/structurizr.sh validate -w workspace.dsl
        echo "‚úÖ C4 DSL valid"
        
    - name: üé® Export C4 Diagrams
      run: |
        echo "üé® Exporting C4 diagrams..."
        cd docs/c4
        mkdir -p exports
        
        # Export PNG and PlantUML with detailed error handling
        echo "üé® Attempting PNG export..."
        if ~/.structurizr/structurizr.sh export -w workspace.dsl -f png -o exports/; then
          echo "‚úÖ PNG export successful"
        else
          echo "‚ùå PNG export failed with exit code $?"
          echo "üîç Trying alternative export approaches..."
          
          # Try without output directory
          ~/.structurizr/structurizr.sh export -w workspace.dsl -f png || echo "Alternative PNG export also failed"
        fi
        
        echo "üé® Attempting PlantUML export..."
        if ~/.structurizr/structurizr.sh export -w workspace.dsl -f plantuml -o exports/; then
          echo "‚úÖ PlantUML export successful"
        else
          echo "‚ùå PlantUML export failed with exit code $?"
        fi
        
        # Check what actually exists
        echo "üìã Checking exports directory:"
        if [ -d "exports" ]; then
          ls -la exports/
          echo "üìä File count: $(ls exports/ 2>/dev/null | wc -l)"
        else
          echo "‚ùå No exports directory created"
        fi
        
        # Create simple architecture overview
        echo '<html><head><title>Architecture</title></head><body><h1>Architecture Diagrams</h1>' > exports/index.html
        
        # Check what files were actually created
        echo "üîç Checking created files..."
        if ls exports/*.png >/dev/null 2>&1; then
          echo "‚úÖ PNG files found, adding to HTML..."
          for png in exports/*.png; do
            basename_png=$(basename "$png")
            echo "<h2>$basename_png</h2><img src=\"$basename_png\" alt=\"Diagram\" style=\"max-width:100%\"/>" >> exports/index.html
          done
        else
          echo "‚ùå No PNG files found"
          echo "<p>No diagrams were generated. Check the build logs for errors.</p>" >> exports/index.html
        fi
        
        echo '</body></html>' >> exports/index.html
        
        echo "üìã Generated files:"
        ls -la exports/
        echo "‚úÖ C4 diagrams exported"
        
    - name: üèóÔ∏è Prepare GitHub Pages Site
      run: |
        echo "üèóÔ∏è Preparing complete site..."
        
        # Start with our beautiful index.html (but not architecture.html - that will be generated)
        mkdir -p _site
        cp index.html _site/
        
        # Add documentation
        mkdir -p _site/docs
        cp -r docs/* _site/docs/
        
        # Add architecture diagrams (simplified approach)
        mkdir -p _site/architecture
        
        echo "üîç Debug: Checking what was generated..."
        echo "üìÇ Contents of docs/c4/:"
        ls -la docs/c4/ || echo "No docs/c4/ directory"
        
        if [ -d "docs/c4/exports" ]; then
          echo "üìÇ Found exports directory, contents:"
          ls -la docs/c4/exports/
          
          # Always copy everything from exports
          cp -r docs/c4/exports/* _site/architecture/ 2>/dev/null || echo "No files in exports"
          
          # Create a simple debug architecture.html that shows what we have
          echo "<html><head><title>Architecture Debug</title></head><body>" > _site/architecture.html
          echo "<h1>Architecture Diagrams Debug</h1>" >> _site/architecture.html
          echo "<p>Build completed successfully. Files found:</p><ul>" >> _site/architecture.html
          
          # List all files in exports
          if ls docs/c4/exports/* >/dev/null 2>&1; then
            for file in docs/c4/exports/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "<li><a href=\"architecture/$filename\">$filename</a></li>" >> _site/architecture.html
                if [[ "$filename" == *.png ]]; then
                  echo "<br><img src=\"architecture/$filename\" alt=\"$filename\" style=\"max-width:100%;border:1px solid #ccc;margin:10px 0;\"/>" >> _site/architecture.html
                fi
              fi
            done
          else
            echo "<li>No files found in exports directory</li>" >> _site/architecture.html
          fi
          
          echo "</ul></body></html>" >> _site/architecture.html
          echo "‚úÖ Debug architecture page created"
        else
          echo "‚ùå No exports directory found"
          echo "<html><head><title>Debug</title></head><body><h1>No exports directory found</h1><p>Structurizr CLI may have failed to export diagrams.</p></body></html>" > _site/architecture.html
        fi
        
        # Add README
        cp README.md _site/
        
        echo "‚úÖ Complete site prepared with:"
        echo "  ‚úì Original index.html (untouched)"
        echo "  ‚úì Architecture diagrams"
        echo "  ‚úì Documentation"
        echo "  ‚úì Direct links working"
        
    - name: üîß Setup Pages
      uses: actions/configure-pages@v4
      
    - name: üì§ Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site/
        
    - name: üöÄ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4