# GitHub Actions Workflow - Architecture Documentation
# Complete, clean version that works with our beautiful index.html

name: 🏗️ Architecture Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'

env:
  STRUCTURIZR_VERSION: '2025.05.28'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    name: 🏗️ Build Architecture Documentation
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 📦 Cache Structurizr CLI
      uses: actions/cache@v3
      with:
        path: ~/.structurizr
        key: structurizr-${{ env.STRUCTURIZR_VERSION }}
        
    - name: 🔧 Setup Structurizr CLI
      run: |
        echo "🔧 Installing Structurizr CLI..."
        mkdir -p ~/.structurizr
        cd ~/.structurizr
        
        wget -q "https://github.com/structurizr/cli/releases/download/v${{ env.STRUCTURIZR_VERSION }}/structurizr-cli.zip"
        unzip -q structurizr-cli.zip
        chmod +x structurizr.sh
        
        ./structurizr.sh version
        echo "✅ Structurizr CLI ready"
        
    - name: 🔍 Validate C4 DSL
      run: |
        echo "🔍 Validating C4 DSL..."
        cd docs/c4
        ~/.structurizr/structurizr.sh validate -w workspace.dsl
        echo "✅ C4 DSL valid"
        
    - name: 🎨 Export C4 Diagrams
      run: |
        echo "🎨 Exporting C4 diagrams..."
        cd docs/c4
        mkdir -p exports
        
        # Export PNG and PlantUML with error handling
        echo "🎨 Attempting PNG export..."
        ~/.structurizr/structurizr.sh export -w workspace.dsl -f png -o exports/ || echo "PNG export failed"
        
        echo "🎨 Attempting PlantUML export..."
        ~/.structurizr/structurizr.sh export -w workspace.dsl -f plantuml -o exports/ || echo "PlantUML export failed"
        
        # Create simple architecture overview
        echo '<html><head><title>Architecture</title></head><body><h1>Architecture Diagrams</h1>' > exports/index.html
        
        # Check what files were actually created
        echo "🔍 Checking created files..."
        if ls exports/*.png >/dev/null 2>&1; then
          echo "✅ PNG files found, adding to HTML..."
          for png in exports/*.png; do
            basename_png=$(basename "$png")
            echo "<h2>$basename_png</h2><img src=\"$basename_png\" alt=\"Diagram\" style=\"max-width:100%\"/>" >> exports/index.html
          done
        else
          echo "❌ No PNG files found"
          echo "<p>No diagrams were generated. Check the build logs for errors.</p>" >> exports/index.html
        fi
        
        echo '</body></html>' >> exports/index.html
        
        echo "📋 Generated files:"
        ls -la exports/
        echo "✅ C4 diagrams exported"
        
    - name: 🏗️ Prepare GitHub Pages Site
      run: |
        echo "🏗️ Preparing complete site..."
        
        # Start with our beautiful index.html
        mkdir -p _site
        cp index.html _site/
        
        # Add documentation
        mkdir -p _site/docs
        cp -r docs/* _site/docs/
        
        # Add architecture diagrams (with debug info)
        mkdir -p _site/architecture
        
        echo "🔍 Debug: Checking what was generated..."
        echo "📂 Contents of docs/c4/:"
        ls -la docs/c4/ || echo "No docs/c4/ directory"
        
        if [ -d "docs/c4/exports" ]; then
          echo "📂 Found exports directory, contents:"
          ls -la docs/c4/exports/
          
          if [ "$(ls -A docs/c4/exports 2>/dev/null)" ]; then
            echo "✅ Exports directory is not empty, copying files..."
            cp -r docs/c4/exports/* _site/architecture/
            
            # Always create direct access to architecture page
            if [ -f "docs/c4/exports/index.html" ]; then
              cp docs/c4/exports/index.html _site/architecture.html
              echo "✅ Real architecture diagrams page created"
            else
              echo "⚠️ Creating fallback architecture page with debug info..."
              echo "<html><head><title>Debug</title></head><body><h1>Architecture Export Debug</h1><p>Exports directory exists but no index.html found.</p><p>Files in exports:</p><ul>" > _site/architecture.html
              for file in docs/c4/exports/*; do
                if [ -f "$file" ]; then
                  echo "<li>$(basename "$file")</li>" >> _site/architecture.html
                fi
              done
              echo "</ul></body></html>" >> _site/architecture.html
            fi
          else
            echo "❌ Exports directory is empty"
          fi
        else
          echo "❌ No exports directory found"
          echo "<html><head><title>Debug</title></head><body><h1>Architecture Export Debug</h1><p>No exports directory was created. Check Structurizr CLI errors.</p></body></html>" > _site/architecture.html
        fi
        
        # Add README
        cp README.md _site/
        
        echo "✅ Complete site prepared with:"
        echo "  ✓ Original index.html (untouched)"
        echo "  ✓ Architecture diagrams"
        echo "  ✓ Documentation"
        echo "  ✓ Direct links working"
        
    - name: 🔧 Setup Pages
      uses: actions/configure-pages@v4
      
    - name: 📤 Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site/
        
    - name: 🚀 Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4