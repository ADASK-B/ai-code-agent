# GitHub Actions Workflow - Architecture Documentation
# Complete, clean version that works with our beautiful index.html

name: 🏗️ Architecture Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'

env:
  STRUCTURIZR_VERSION: '2025.05.28'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    name: 🏗️ Build Architecture Documentation
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 📦 Cache Structurizr CLI
      uses: actions/cache@v3
      with:
        path: ~/.structurizr
        key: structurizr-${{ env.STRUCTURIZR_VERSION }}
        
    - name: 🔧 Setup Structurizr CLI
      run: |
        echo "🔧 Installing Structurizr CLI..."
        mkdir -p ~/.structurizr
        cd ~/.structurizr
        
        # Check if already installed
        if [ ! -f "structurizr.sh" ]; then
          echo "📥 Downloading Structurizr CLI..."
          wget -q "https://github.com/structurizr/cli/releases/download/v${{ env.STRUCTURIZR_VERSION }}/structurizr-cli.zip"
          echo "📦 Extracting (force overwrite)..."
          unzip -o -q structurizr-cli.zip
          chmod +x structurizr.sh
          echo "🗑️ Cleaning up..."
          rm -f structurizr-cli.zip
        else
          echo "✅ Structurizr CLI already installed (from cache)"
        fi
        
        ./structurizr.sh version
        echo "✅ Structurizr CLI ready"
        
    - name: 🔍 Validate C4 DSL
      run: |
        echo "🔍 Validating C4 DSL..."
        cd docs/c4
        ~/.structurizr/structurizr.sh validate -w workspace.dsl
        echo "✅ C4 DSL valid"
        
    - name: 🎨 Export C4 Diagrams
      run: |
        echo "🎨 Exporting C4 diagrams..."
        cd docs/c4
        mkdir -p exports
        
        # Export PNG and PlantUML with detailed error handling
        echo "🎨 Attempting PNG export..."
        if ~/.structurizr/structurizr.sh export -w workspace.dsl -f png -o exports/; then
          echo "✅ PNG export successful"
        else
          echo "❌ PNG export failed with exit code $?"
          echo "🔍 Trying alternative export approaches..."
          
          # Try without output directory
          ~/.structurizr/structurizr.sh export -w workspace.dsl -f png || echo "Alternative PNG export also failed"
        fi
        
        echo "🎨 Attempting PlantUML export..."
        if ~/.structurizr/structurizr.sh export -w workspace.dsl -f plantuml -o exports/; then
          echo "✅ PlantUML export successful"
        else
          echo "❌ PlantUML export failed with exit code $?"
        fi
        
        # Check what actually exists
        echo "📋 Checking exports directory:"
        if [ -d "exports" ]; then
          ls -la exports/
          echo "📊 File count: $(ls exports/ 2>/dev/null | wc -l)"
        else
          echo "❌ No exports directory created"
        fi
        
        # Create simple architecture overview
        echo '<html><head><title>Architecture</title></head><body><h1>Architecture Diagrams</h1>' > exports/index.html
        
        # Check what files were actually created
        echo "🔍 Checking created files..."
        if ls exports/*.png >/dev/null 2>&1; then
          echo "✅ PNG files found, adding to HTML..."
          for png in exports/*.png; do
            basename_png=$(basename "$png")
            echo "<h2>$basename_png</h2><img src=\"$basename_png\" alt=\"Diagram\" style=\"max-width:100%\"/>" >> exports/index.html
          done
        else
          echo "❌ No PNG files found"
          echo "<p>No diagrams were generated. Check the build logs for errors.</p>" >> exports/index.html
        fi
        
        echo '</body></html>' >> exports/index.html
        
        echo "📋 Generated files:"
        ls -la exports/
        echo "✅ C4 diagrams exported"
        
    - name: 🏗️ Prepare GitHub Pages Site
      run: |
        echo "🏗️ Preparing complete site..."
        
        # Start with our beautiful index.html (but not architecture.html - that will be generated)
        mkdir -p _site
        cp index.html _site/
        
        # Add documentation
        mkdir -p _site/docs
        cp -r docs/* _site/docs/
        
        # Add architecture diagrams (simplified approach)
        mkdir -p _site/architecture
        
        echo "🔍 Debug: Checking what was generated..."
        echo "📂 Contents of docs/c4/:"
        ls -la docs/c4/ || echo "No docs/c4/ directory"
        
        # Always copy the beautiful template for architecture page
        echo "📄 Using architecture template"
        echo "📂 Checking if template exists:"
        ls -la architecture-template.html || echo "❌ Template not found!"
        echo "📂 Checking target directory:"
        ls -la _site/ || echo "❌ _site directory not found!"
        
        if [ -f "architecture-template.html" ]; then
          cp architecture-template.html _site/architecture.html
          echo "✅ Template copied successfully"
          echo "📂 Verifying copied file:"
          ls -la _site/architecture.html
          echo "📄 First few lines of copied file:"
          head -5 _site/architecture.html
        else
          echo "❌ Template file does not exist!"
        fi
        
        if [ -d "docs/c4/exports" ]; then
          echo "📂 Found exports directory, contents:"
          ls -la docs/c4/exports/
          
          # Copy everything from exports
          cp -r docs/c4/exports/* _site/architecture/ 2>/dev/null || echo "No files in exports"
        fi
        
        # Add README
        cp README.md _site/
        
        echo "✅ Complete site prepared with:"
        echo "  ✓ Original index.html (untouched)"
        echo "  ✓ Architecture diagrams"
        echo "  ✓ Documentation"
        echo "  ✓ Direct links working"
        
    - name: 🔧 Setup Pages
      uses: actions/configure-pages@v4
      
    - name: 📤 Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site/
        
    - name: 🚀 Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4